name: Cluster1 CI

on:
  push:
    branches: ["main"]
  pull_request:
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      gpu: ${{ steps.filter.outputs.gpu }}
    steps:
      - uses: actions/checkout@v4
      - name: Determine whether GPU smoke should run
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            gpu:
              - 'cluster1_cli.py'
              - 'unit_testing/**'
              - 'data/smoke/**'
              - 'Makefile'
              - 'adapters/**'
              - '.github/workflows/**'
              - 'requirements.lock.txt'

  cpu_checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal deps (CPU checks)
        run: |
          python -m pip install --upgrade pip
          pip install ruff pytest

      # Keep ruff strict on real errors, not style wars.
      - name: Lint (ruff - only critical rules)
        run: |
          ruff --version
          ruff check . --select F,E9

      - name: Unit tests (strict rules)
        run: |
          pytest -q

  gpu_smoke:
    runs-on: [self-hosted, gpu]
    needs: [cpu_checks, changes]
    # - always run on push to main
    # - on PRs, run only if relevant files changed AND PR is from same repo (not fork)
    # - allow manual runs via workflow_dispatch
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && needs.changes.outputs.gpu == 'true' && github.event.pull_request.head.repo.full_name == github.repository) ||
      (github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Show runner context
        shell: bash
        run: |
          set -euxo pipefail
          whoami
          pwd
          nvidia-smi

      - name: Activate persistent venv
        shell: bash
        run: |
          set -euxo pipefail
          VENV="$HOME/venvs/cluster1"
          if [ ! -f "$VENV/bin/activate" ]; then
            echo "Missing venv at $VENV"
            echo "Create it once on the runner box (as gha):"
            echo "  python3 -m venv $VENV"
            echo "  source $VENV/bin/activate"
            echo "  pip install --upgrade pip"
            echo "  # install your known-good stack"
            echo "  pip install torch==2.9.1+cu128 --index-url https://download.pytorch.org/whl/cu128"
            echo "  pip install transformers==4.57.3 peft==0.18.0"
            exit 1
          fi
          echo "VENV=$VENV" >> "$GITHUB_ENV"

      - name: Smoke gate
        shell: bash
        run: |
          set -euxo pipefail
          source "$VENV/bin/activate"
          python -c "import torch, transformers, peft; print('torch',torch.__version__); print('transformers',transformers.__version__); print('peft',peft.__version__)"
          make smoke

      - name: Upload smoke reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-reports
          path: reports/*.jsonl
